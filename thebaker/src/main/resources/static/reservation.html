<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>THE BAKER - 예약</title>

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-F54HS1GX0M"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-F54HS1GX0M');
    </script>
    <script type="text/javascript">
        (function(c,l,a,r,i,t,y){
            c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
            t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
            y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
        })(window, document, "clarity", "script", "v5bcs3qciu");
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Arial', 'sans-serif'],
                        serif: ['Pretendard', 'sans-serif'],
                        nav: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        brown: '#6B4423',
                        darkbrown: '#47280e',
                        black: '#111111',
                        white: '#FFFFFF',
                        gray: '#F4F4F4',
                        cream: '#f9f7f2',
                        success: '#22c55e',
                        danger: '#ef4444'
                    }
                }
            }
        }
    </script>
    <style>
        @font-face { font-family: 'Pretendard'; src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/pretendard@1.0/Pretendard-Regular.woff2') format('woff2'); font-weight: 400; font-display: swap; }
        @font-face { font-family: 'Pretendard'; src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/pretendard@1.0/Pretendard-SemiBold.woff2') format('woff2'); font-weight: 600; font-display: swap; }
        @font-face { font-family: 'Pretendard'; src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/pretendard@1.0/Pretendard-Bold.woff2') format('woff2'); font-weight: 700; font-display: swap; }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        html { overflow-y: scroll; }
    </style>
</head>
<body class="bg-white text-brown font-sans antialiased">

<nav class="fixed top-0 w-full z-50 bg-white/90 backdrop-blur-md border-b border-black/5">
    <div class="max-w-screen-xl mx-auto px-4 md:px-6 h-16 flex justify-between items-center">
        <a href="index.html" class="text-[20px] md:text-[24px] font-semibold tracking-tight hover:opacity-70 transition">THE BAKER</a>
        <div class="flex space-x-4 md:space-x-8 text-[14px] md:text-[15px] font-bold tracking-tight md:tracking-wider">
            <a href="about.html" class="hover:text-brown transition">소개</a>
            <a href="menu.html" class="hover:text-brown transition">메뉴</a>
            <a href="reservation.html" class="hover:text-brown transition">예약</a>
        </div>
    </div>
</nav>

<main class="pt-28 pb-24 px-4 md:px-6 max-w-screen-xl mx-auto overflow-hidden">
    <h1 class="text-3xl font-bold mb-8 tracking-[-0.03em] uppercase mt-4">당일 예약</h1>

    <div class="space-y-4 mb-8 pb-8 border-b border-gray-100">
        <div class="mb-8 text-lg font-bold">
            픽업 날짜: <span id="displayDate">Today</span>
        </div>
        <div class="flex flex-col max-w-ws">
            <label class="text-lg font-bold mb-1 uppercase text-gray-700">픽업 시간</label>
            <select id="pickup-time" class="w-full bg-gray-50 border border-gray-200 p-3 rounded-sm font-bold text-black focus:border-brown focus:outline-none appearance-none">
                <option>12:00 PM</option>
                <option>1:00 PM</option>
                <option>2:00 PM</option>
                <option>3:00 PM</option>
                <option>4:00 PM</option>
            </select>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 pt-2">
            <input type="text" id="custName" placeholder="성함" class="w-full bg-white border-b border-gray-300 py-2 text-base focus:outline-none focus:border-black transition rounded-none">
            <input type="tel" id="custPhone" placeholder="핸드폰 번호" class="w-full bg-white border-b border-gray-300 py-2 text-base focus:outline-none focus:border-black transition rounded-none">
        </div>
    </div>

    <div class="mb-12">
        <h3 class="text-xl font-bold mb-3 flex flex-col">
            <span>메뉴 선택</span>
            <span class="text-base text-gray-400 font-semibold">*예약은 당일 오후 12시부터 매장 운영 마감 시간까지만 가능합니다. </span>
        </h3>
        <div id="menu-list" class="space-y-4 min-h-[100px]"></div>
    </div>

    <div class="bg-gray-50 p-6 rounded-xl border ">
        <div class="flex justify-between items-center mb-6">
            <span class="text-sm font-bold uppercase tracking-wide text-gray-400">총 결제금액</span>
            <span class="text-2xl font-black text-black" id="totalPrice">0 원</span>
        </div>

        <div class="flex items-start space-x-3 mb-6 bg-white p-4 border border-gray-100 rounded-lg">
            <input type="checkbox" id="marketingConsent" class="mt-1 w-4 h-4 accent-brown shrink-0">
            <label for="marketingConsent" class="text-xs text-gray-500 leading-tight">
                <span class="font-bold text-brown uppercase block mb-1">마케팅 수신 동의 (선택)</span>
                더베이커 마케팅 수신에 동의하시면 체크해주세요.
            </label>
        </div>

        <div class="grid grid-cols-2 gap-3 mb-4">
            <label class="cursor-pointer border border-gray-200 rounded p-3 flex items-center justify-between hover:bg-gray-50">
                <span class="text-xs font-bold text-gray-600">포장 여부 </span>
                <input type="checkbox" id="optTakeaway" class="accent-brown w-4 h-4">
            </label>

            <label class="cursor-pointer border border-gray-200 rounded p-3 flex items-center justify-between hover:bg-gray-50">
                <span class="text-xs font-bold text-gray-600">컷팅 여부 </span>
                <input type="checkbox" id="optCut" class="accent-brown w-4 h-4">
            </label>
        </div>

        <div class="mb-4">
            <label class="block text-sm font-bold text-gray-700 mb-1">요청사항</label>
            <textarea id="orderMemo" rows="2"
                      class="w-full border border-gray-300 rounded p-2 text-sm focus:outline-none focus:border-brown"
                      placeholder="추가적인 요청사항이 있으시면 말씀해주세요. (선택사항)"></textarea>
        </div>

        <button onclick="finishReservation()" class="w-full bg-brown text-white py-4 text-xl font-bold uppercase tracking-wide hover:bg-darkbrown transition shadow-lg">
            예약 요청하기 (재고 확인)
        </button>
        <p class="text-[17px] text-gray-400 mt-4 text-center font-bold leading-relaxed">
            * 예약 요청을 하시면 직원이 재고를 확인합니다.<br>
            * 재고 확인 후 입금 안내창이 뜹니다.
        </p>
    </div>
</main>

<a href="my-order.html" class="block text-center mt-4 text-base text-gray-500">
    내 예약 확인 / 취소
</a>

<footer class="bg-white py-12 px-6 mt-auto">
    <div class="max-w-screen-xl mx-auto flex flex-col md:flex-row justify-between items-center text-[13px] uppercase tracking-wide text-gray-400">
        <p class="font-bold tracking-tight">&copy; 2026 THE BAKER DAEJEON</p>
        <div class="space-x-6 mt-4 md:mt-0 font-bold">
            <a href="#">인스타그램</a>
            <a href="/privacy">개인정보</a>
        </div>
    </div>
</footer>

<div id="waiting-modal" class="hidden fixed inset-0 z-[70] flex items-center justify-center">
    <div class="absolute inset-0 bg-black/90 backdrop-blur-sm"></div>
    <div class="relative bg-white w-full max-w-sm mx-6 p-8 rounded-xl shadow-2xl text-center">
        <div class="inline-block animate-spin rounded-full h-10 w-10 border-4 border-gray-100 border-t-brown mb-6"></div>
        <h3 class="text-xl font-bold mb-2 text-black">재고 확인 중입니다.</h3>
        <p class="text-gray-500 text-sm mb-6 leading-relaxed">
            매장에서 주문 내용을 확인하고 있습니다.<br>
            확인이 완료되면 입금 계좌번호가 뜹니다.
        </p>
        <p class="text-lg text-red-500 font-bold animate-pulse">
            * 화면을 닫지 마시고 잠시만 기다려주세요!
        </p>
    </div>
</div>

<div id="bank-modal" class="hidden fixed inset-0 z-[60] flex items-center justify-center">
    <div class="absolute inset-0 bg-black/80 backdrop-blur-sm"></div>

    <div class="relative bg-white w-full max-w-sm mx-4 p-6 shadow-2xl">

        <!-- 모바일 강조 안내 -->
        <div class="mb-6 rounded-md bg-brown/10 border-l-4 border-brown px-4 py-3">
            <p class="text-sm font-black text-brown leading-tight">
                주문이 성공적으로 완료되었습니다
            </p>
            <p class="text-[13px] text-gray-800 mt-1 leading-snug">
                아래 계좌로 입금 후<br class="sm:hidden">
                <span class="font-bold">입금 완료 버튼</span>을 눌러주세요
            </p>
        </div>

        <h3 class="text-lg font-bold mb-5 tracking-tight text-black">
            입금 계좌
        </h3>

        <div class="space-y-4 mb-8 text-black">
            <div class="p-4 bg-gray-50 border border-gray-200">
                <p class="text-[11px] uppercase tracking-widest text-gray-400 mb-1">
                    은행
                </p>
                <p class="text-lg font-bold">
                    케이뱅크 (김현균)
                </p>
            </div>

            <div
                    class="p-4 bg-gray-50 border border-gray-200 active:bg-gray-100 cursor-pointer"
                    onclick="copyAccount()"
            >
                <p class="text-[11px] uppercase tracking-widest text-gray-400 mb-1">
                    계좌번호 (탭해서 복사)
                </p>
                <p class="text-xl font-mono font-bold">
                    100-131-256857
                </p>
            </div>

            <div class="flex justify-between items-center pt-4 border-t border-gray-200">
                <span class="text-sm font-bold text-gray-500">
                    입금하실 금액
                </span>
                <span class="text-xl font-black text-brown" id="modalTotal">
                    0
                </span>
            </div>
        </div>

        <button
                onclick="confirmPayment()"
                class="w-full bg-brown text-white py-4 text-sm font-bold tracking-wide active:bg-black transition shadow-lg"
        >
            입금 완료 (완료 후 버튼을 꼭 눌러주세요!)
        </button>
    </div>
</div>

<div id="closed-overlay" class="hidden fixed inset-0 z-[100] flex items-center justify-center bg-white/80 backdrop-blur-md">
    <div class="bg-white border border-gray-200 p-8 rounded-xl shadow-2xl text-center max-w-sm mx-6">
        <div class="text-4xl mb-4">⏳</div>
        <h2 class="text-2xl font-bold mb-3 text-black">지금은 예약 시간이 아닙니다.</h2>
<!--        <p class="text-gray-600 text-base mb-8 leading-relaxed">-->
<!--            당일 예약은 재고 파악을 위해<br>-->
<!--            <span class="text-brown font-black bg-gray-100 px-2 py-1 rounded">오후 12:00</span> 부터 가능합니다.-->
<!--        </p>-->
        <a href="index.html" class="block w-full bg-black text-white py-4 font-bold rounded-lg hover:bg-gray-800 transition">
            메인으로 돌아가기
        </a>
    </div>
</div>

<script>
    // --- 1. INITIALIZE ---
    document.getElementById('displayDate').innerText = new Date().toLocaleDateString('ko-KR', {
        year: 'numeric', month: 'long', day: 'numeric', weekday: 'short'
    });

    let cart = {};
    let productData = [];

    // --- NEW: CHECK RESERVATION TIME ---
    async function checkReservationStatus() {
        try {
            const res = await fetch('/api/staff/status');
            if (res.ok) {
                const data = await res.json();
                const overlay = document.getElementById('closed-overlay');
                
                // If reservationOpen is FALSE -> SHOW the blocking box
                if (data.reservationOpen === false) {
                    overlay.classList.remove('hidden');
                    document.body.style.overflow = 'hidden'; // Stop scrolling
                } else {
                    overlay.classList.add('hidden');
                    document.body.style.overflow = ''; // Allow scrolling
                }
            }
        } catch (e) {
            console.error("Status check failed", e);
        }
    }
    // Run this immediately when page opens
    checkReservationStatus();

    // --- 2. FETCH MENU ---
    async function fetchMenuForDate() {
        const list = document.getElementById('menu-list');
        list.innerHTML = '<div class="animate-pulse text-gray-300">잠시만 기다려주세요...</div>';

        try {
            const res = await fetch(`/api/products`);
            productData = await res.json();

            // Sort logic (Drinks vs Bread, Stock)
            productData.sort((a, b) => {
                const drinkKeywords = ["라떼", "아메리카노"];
                const isDrinkA = drinkKeywords.some(k => a.name.includes(k));
                const isDrinkB = drinkKeywords.some(k => b.name.includes(k));
                if (isDrinkA && !isDrinkB) return 1;
                if (!isDrinkA && isDrinkB) return -1;
                return b.stockQuantity - a.stockQuantity;
            });

            list.innerHTML = '';
            if(productData.length === 0) {
                list.innerHTML = '<div class="text-red-400 font-bold">현재 예약 가능한 제품이 없습니다.</div>';
                return;
            }

            productData.forEach(p => {
                const priceFmt = new Intl.NumberFormat('ko-KR').format(p.price);
                const isSoldOut = p.stockQuantity <= 0;
                const stockText = isSoldOut ? '(품절)' : `(${p.stockQuantity}개 남음)`;
                const btnDisabled = isSoldOut ? 'disabled class="w-8 h-8 rounded-full bg-gray-200 text-gray-400 cursor-not-allowed"' : 'class="w-8 h-8 rounded-full bg-black text-white hover:bg-brown font-bold"';
                const opacity = isSoldOut ? 'opacity-50' : '';

                const itemHTML = `
                    <div class="flex justify-between items-center border border-gray-100 p-4 rounded-lg bg-white shadow-sm ${opacity}">
                        <div>
                            <h4 class="font-bold text-lg">${p.name}</h4>
                            <p class="text-sm text-gray-500">₩${priceFmt} <span class="text-red-500 text-xs font-bold">${stockText}</span></p>
                        </div>
                        <div class="flex items-center space-x-3">
                            <button onclick="updateQty(${p.id}, -1)" class="w-8 h-8 rounded-full bg-gray-100 hover:bg-gray-200 font-bold">-</button>
                            <span id="qty-${p.id}" class="w-4 text-center font-bold">0</span>
                            <button onclick="updateQty(${p.id}, 1)" ${btnDisabled}>+</button>
                        </div>
                    </div>
                `;
                list.insertAdjacentHTML('beforeend', itemHTML);
            });
        } catch(e) {
            console.error(e);
            list.innerHTML = 'Error loading menu.';
        }
    }

    // --- 3. CART LOGIC ---
    function updateQty(id, change) {
        if(!cart[id]) cart[id] = 0;
        const product = productData.find(p => p.id === id);
        if (change > 0 && cart[id] >= product.stockQuantity) {
            alert(`죄송합니다. 현재 재고가 ${product.stockQuantity}개만 있습니다.`);
            return;
        }
        cart[id] += change;
        if(cart[id] < 0) cart[id] = 0;
        document.getElementById(`qty-${id}`).innerText = cart[id];
        updateTotal();
    }

    function updateTotal() {
        let total = 0;
        for (const [id, qty] of Object.entries(cart)) {
            const product = productData.find(p => p.id == id);
            if(product) total += product.price * qty;
        }
        const fmt = new Intl.NumberFormat('ko-KR').format(total) + " 원";
        document.getElementById('totalPrice').innerText = fmt;
        const modalTotal = document.getElementById('modalTotal');
        if(modalTotal) modalTotal.innerText = fmt;
    }

    // --- 4. UTILS ---
    function copyAccount() { navigator.clipboard.writeText("100-131-256857"); alert("계좌번호가 복사되었습니다!"); }

    // --- 5. RESERVATION LOGIC (THE NEW FLOW) ---
    async function finishReservation() {
        const nameEl = document.getElementById('custName');
        const phoneEl = document.getElementById('custPhone');

        if (!nameEl.value || !phoneEl.value) { alert("성함과 연락처를 입력해주세요."); return; }

        const items = [];
        if (typeof cart !== 'undefined') {
            for (const [id, qty] of Object.entries(cart)) {
                if (qty > 0) items.push({ productId: parseInt(id), quantity: qty });
            }
        }
        if (items.length === 0) { alert("메뉴를 선택해주세요."); return; }

        if(!confirm("예약을 요청하시겠습니까? (재고 확인 후에 결제창이 뜹니다)")) return;

        const payload = {
            customerName: nameEl.value,
            phoneNumber: phoneEl.value,
            items: items,
            pickupTime: document.getElementById('pickup-time').value,
            takeaway: document.getElementById('optTakeaway') ? document.getElementById('optTakeaway').checked : false,
            wantsCut: document.getElementById('optCut') ? document.getElementById('optCut').checked : false,
            memo: document.getElementById('orderMemo').value,
            marketingConsent: document.getElementById('marketingConsent') ? document.getElementById('marketingConsent').checked : false
        };

        try {
            // SEND POST
            const res = await fetch('/api/orders', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });

            if (res.ok) {
                const orderData = await res.json();

                // ** SHOW WAITING MODAL, HIDE BANK MODAL **
                document.getElementById('waiting-modal').classList.remove('hidden');
                document.getElementById('bank-modal').classList.add('hidden');

                // Start polling
                startPolling(orderData.id);

            } else {
                alert("예약 실패: " + await res.text());
            }

        } catch (e) {
            alert("시스템 오류: " + e.message);
        }
    }

    // --- 6. POLLING ---
    function startPolling(orderId) {
        const pollInterval = setInterval(async () => {
            try {
                const res = await fetch(`/api/orders/${orderId}/status`);
                if (res.ok) {
                    const status = await res.text();

                    // IF STAFF CONFIRMED (PROCESSING)
                    if (status === 'PROCESSING') {
                        clearInterval(pollInterval);

                        // Switch Modals
                        document.getElementById('waiting-modal').classList.add('hidden');
                        document.getElementById('bank-modal').classList.remove('hidden');
                    }
                    // IF CANCELLED
                    else if (status === 'CANCELLED') {
                        clearInterval(pollInterval);
                        alert("죄송합니다. 재고 부족으로 주문이 취소되었습니다.");
                        location.reload();
                    }
                }
            } catch (e) { console.error("Polling error", e); }
        }, 2000);
    }

    // --- 7. FINAL CONFIRM PAYMENT ---
    function confirmPayment() {
        alert("✅ 예약이 완료되었습니다!\n\n선택하신 시간에 픽업해주세요.\n감사합니다!");
        location.reload();
    }

    // --- 8. INIT ---
    fetchMenuForDate();

    // --- 9. NAV HIGHLIGHT ---
    document.addEventListener("DOMContentLoaded", () => {
        const path = window.location.pathname;
        if (path.includes("about")) document.getElementById("link-about").classList.add("opacity-50", "pointer-events-none");
        else if (path.includes("menu")) document.getElementById("link-menu").classList.add("opacity-50", "pointer-events-none");
        else if (path.includes("reservation")) document.getElementById("link-reservation").classList.add("opacity-50", "pointer-events-none");
    });

    // --- 10. PWA INSTALLATION ---
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('/sw.js')
                .then(registration => console.log('App Ready'))
                .catch(err => console.log('App Error', err));
        });
    }
</script>

</body>
</html>